# Manage FHIR resources using FHIR Engine Library

## Before you begin

### What you'll build

In this codelab, you'll build an Android app using FHIR Engine Library. Your app
will use FHIR Engine Library to download FHIR resources from a FHIR server, and
upload any local changes to the server.

### What you'll learn

*   How to create a local HAPI FHIR server using Docker
*   How to integrate FHIR Engine Library into your Android application
*   How to use the Sync API to set up a one-time or periodic job to download and
    upload FHIR resources
*   How to use the Search API to find
*   How to use the Data Access APIs to create, read, update, and delete FHIR resources locally
### What you'll need

*   Docker ([get Docker](https://docs.docker.com/get-docker/))
*   A recent version of
    [Android Studio (v4.1.2+)](https://developer.android.com/studio)
*   [Android Emulator](https://developer.android.com/studio/run/emulator) or a
    physical Android device running Android 7.0 Nougat or later
*   The sample code
*   Basic knowledge of Android development in Kotlin

If you haven't built Android apps before, you can
start by [building your first
app](https://developer.android.com/training/basics/firstapp).

## Set up a local HAPI FHIR server with test data

[HAPI FHIR](https://hapifhir.io/hapi-fhir/) is a popular open-source FHIR
server. We will use a local HAPI FHIR server in our codelab for the Android app
to connect to.

### Set up a local HAPI FHIR server

1.   Run the following command in a terminal to get the latest image of HAPI FHIR

```shell
docker pull hapiproject/hapi:latest
```

2.   Create a HAPI FHIR container by either
     using Docker Desktop to run the previously download image `hapiproject/hapi`, or
     running the following command

```shell
docker run -p 8080:8080 hapiproject/hapi:latest
```

Learn [more](https://github.com/hapifhir/hapi-fhir-jpaserver-starter#running-via-docker-hub).

3. Inspect the server by opening the URL `http://localhost:8080/` in a browser.
   You should see the HAPI FHIR web interface.

![HAPI FHIR web interface](fhir-engine/image1.png "HAPI FHIR web interface")

### Populate the local HAPI FHIR server with test data

To test our application, we'll need some test data on the server. We'll use
synthetic data generated by Synthea.

1.   First, we need to download sample data from [synthea-samples](https://github.com/synthetichealth/synthea-sample-data/tree/master/downloads). Download and unzip
     `synthea_sample_data_fhir_r4_sep2019.zip`. The un-zipped sample data has
     numerous `.json` files, each being a transaction bundle for an individual
     patient.

2.   We'll upload test data for three patients to the local HAPI FHIR server.
     Run the following command in the directory containing JSON files

```shell
curl -X POST -H "Content-Type: application/json" -d @./Aaron697_Brekke496_2fa15bc7-8866-461a-9000-f739e425860a.json http://localhost:8080/fhir/
curl -X POST -H "Content-Type: application/json" -d @./Aaron697_Stiedemann542_41166989-975d-4d17-b9de-17f94cb3eec1.json http://localhost:8080/fhir/
curl -X POST -H "Content-Type: application/json" -d @./Abby752_Kuvalis369_2b083021-e93f-4991-bf49-fd4f20060ef8.json http://localhost:8080/fhir/
```

3.   To upload test data for all patients to the server, run

```shell
for f in *.json; do curl -X POST -H "Content-Type: application/json" -d @$f http://localhost:8080/fhir/ ; done
```

However, this can take a long time to complete and is not necessary for the codelab.

4. Verify that the test data is available on the server by opening the URL
   `http://localhost:8080/fhir/Patient/` in a browser. You should see the text
   `HTTP 200 OK` and the `Response Body` section of the page containing patient
   data in a FHIR Bundle as the search result with a `total` count.

![Test data on server](fhir-engine/image2.png "Test data on server")

## Set up the Android app

### Download the Code

To download the code for this codelab, clone the Android FHIR SDK repo: `git
clone https://github.com/google/android-fhir.git`

The starter project for this codelab is located in `codelabs/engine`.

### Import the app into Android Studio

Let's start by importing the starter app into Android Studio.

Open Android Studio, select **Import Project (Gradle, Eclipse ADT, etc.)** and
choose the `codelabs/engine/` folder from the source code that you have
downloaded earlier.

![Android Studio start screen](fhir-engine/image3.png "Android Studio start
screen")

### Run the starter app

Now that you have imported the project into Android Studio, you are ready to run
the app for the first time.

Connect your Android device via USB to your host, or [start the Android Studio
emulator](https://developer.android.com/studio/run/emulator), and click Run
(![Run button](fhir-engine/image4.png "Run button")) in the Android Studio
toolbar.

<img src="fhir-engine/image5.png" alt="Hello World app" width="300">

## Add FHIR Engine Library to the project

### Add the dependencies for FHIR Engine Library

The FHIR Engine Library dependencies allow you to integrate the
Structured Data Capture Library in your app. Add the following lines to the end
of the `app/build.gradle.kts` file of your project:

```kotlin
dependencies {
    // ...

    implementation("com.google.android.fhir:engine:0.1.0-beta03")
    implementation("androidx.fragment:fragment-ktx:1.5.5")
}
```

### Sync your project with Gradle files

To be sure that all dependencies are available to your app, you should sync your
project with gradle files at this point.

Select **Sync Project with Gradle Files** (![Gradle sync
button](data-capture/image3.png "Gradle sync button")) from the Android Studio
toolbar. You an also run the app again to check the dependencies are working
correctly.
